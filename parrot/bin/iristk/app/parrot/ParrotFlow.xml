<?xml version="1.0" encoding="utf-8"?>
<flow name="ParrotFlow" package="iristk.app.parrot" 
	initial="Init" xmlns:this="iristk.app.parrot.ParrotFlow" xmlns="iristk.flow" 
	xmlns:p="iristk.flow.param" xmlns:agent="iristk.situated.SystemAgentFlow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="iristk.flow flow.xsd iristk.situated.SystemAgentFlow SystemAgentFlow.xsd">
	
	<param name="agent" type="iristk.situated.SystemAgentFlow"/>
	<var name="system" type="iristk.situated.SystemAgent" value="agent.getSystemAgent()"/> 
	
	<state id="Dialog">
		<onentry>
			<agent:listen/>
			<reentry/>
		</onentry>
		<onevent name="sense.user.speech.start" cond="system.isAttending(event) and eq(event:speakers, 1)">
			<agent:gesture name="'smile'"/>
		</onevent>
		<onevent name="sense.user.speak.multi">
			<random>
				<agent:say>Hey humans! one at a time</agent:say>
				<agent:say>Ah! Shut up you guys!</agent:say>
				<agent:say>Too Loud! You are making it too loud!</agent:say>
				<agent:say>Don't speak at the same time.</agent:say>
			</random>
		</onevent>
		<onevent name="sense.user.speak" cond="!eq(event:text,'NO_MATCH')">
		    <agent:say><expr>event:text</expr></agent:say>
		</onevent>
		<onevent name="sense.user.silence" cond="!system.getCurrentUser().isNobody()">
			<random>
				<agent:say>Talk or I'll kill you</agent:say>
				<agent:say>I have all day to wait!</agent:say>
			</random>
		</onevent>
		<onevent name="sense.user.leave" cond="system.isAttending(event)">
			<if cond="system.hasUsers()">
				<agent:attendRandom/>
				<reentry/>
			<else />
				<agent:say>Bye.</agent:say>
				<reentry/>
			</if>
		</onevent>
		
		<onevent name="sense.user.enter">
			<agent:attend target="event:user"/>
			<agent:listen/>
		</onevent>
	</state>
	
	<state id="Init">
		<!-- State that ensures state of system on starting skill. Place any initial setting, e.g. voice, here.-->
		<onentry>
		<exec>
			system.setMaxUsers(2);
			system.setInteractionDistance(2);
		</exec>
			<if cond="system.hasUsers()">
				<agent:attendRandom/>
			<else/>
				<agent:attendNobody/>
			</if>
		    <goto state="Dialog"/>
		</onentry>
	</state>
	
</flow>